====== LVS начало + Direct Routing ======

Что такое LVS (Linux Virtual Server) – это встроенный компонент в ядре Linux, который обеспечивает перенаправление IP пакетов на группу серверов, обрабатывающих эти пакеты.

Что такое IPVSADM – это просто консольная утилита для настройки и взаимодействия с LVS.

Что такое KEEPALIVED – это ПО в виде демона, с помощью которого можно настраивать как LVS так и VRRP путем редактирования конфига.

И… Т.е. при использовании KEEPALIVED для настройки балансера не обязательно устанавливать IPVSADM, но она полезна тем, что с ее помощью можно посмотреть, как настроен LVS.

Ммм… почему нельзя обойтись без KEEPALIVED и просто использовать IPVSADM? Можно конечно, но воспринимайте KEEPALIVED как удобный инструмент для настройки балансера. Также с помощью него можно легко настроить еще и запасной (standby) балансировщик, с использованием технологии VRRP.

Ну хорошо. Давай начнем с IPVSADM, а там посмотрим. Для начала нужно ознакомиться с возможностями LVS [[https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/5/html/virtual_server_administration/ch-lvs-overview-vsa| здесь]] или [[http://www.linuxvirtualserver.org/how.html|здесь]] или [[http://www.ultramonkey.org/papers/lvs_tutorial/html/|здесь]].

Из прочитанного становится ясно, что есть Direct Routing и NAT, ну и IP Tunneling. Начнем с Direct Routing и забудем пока об отказоустойчивости балансировщика.

Представим, что у нас везде белые IP адреса на Real Server-ах запущен nginx на порту 80. Т.е. мы хотим перенапрявлять запросы на порт 80 на RealServer 01 и RealServer 02.

{{ :lvs_directrouting_scheme.png?400 |}}

Вот так примерно выглядит схема. Красными и зелеными стрелками показана схема движения пакетов.
Виртуальный IP адрес (VIP) является общим для реальных серверов и балансировщика. Виртуальный IP на балансировщике нужен для того, чтобы принимать пакеты с запросом и напрямую перенапрявлять их реальным серверам. Все реальные сервера должны иметь сконфигурированные алиасы на интерфейсе для приема пакетов на виртуальный IP адрес, чтобы сервер мог локально обработать принятые пакеты. Причем эти алиасы не должны обрабатывать arp запросы. Физические интерфейсы балансировщика и реальных серверов обязательно должны быть соединены через hub/switch. Такое соединение необходимо т.к. балансировщик отправляет пакеты напрямую (по mac адресу) реальному серверу. Также все эти сервера должны находится в одной подсети. Более подробно [[http://www.linuxvirtualserver.org/VS-DRouting.html|здесь]].

===== Приступим непосредственно к настройке балансировщика. =====

==== Включаем форвардинг пакетов ====

<code>
echo 1 > /proc/sys/net/ipv4/ip_forward
</code>

==== Настроим VIP на балансировщике ====

<code>
#/etc/network/interfaces
auto eth0:0
iface eth0:0 inet static
	address 192.200.0.198
	netmask 255.255.255.0
</code>

<code>
ifup eth0:0
</code>

Настройка VIP на реальных серверах может осуществляться различными способами. Самое главное избежать так называемой ARP Problem. Это когда алиас интерфейс для виртуального IP настроен так, что он отвечает на arp запросы. Читаем [[http://www.linuxvirtualserver.org/docs/arp.html|здесь]].

Я лично выбрал метод с помощью iptables.
<code>
iptables –t nat –A PREROUTING –d 192.200.0.198 –j REDIRECT
</code>

Т.е. когда пакет попадает на сервер он не отбрасывается, а передается на обработку localhost-у на тот же порт на который он пытался попасть.

==== Теперь настроим LVS ====

<code>
# -A - добавляем виртуальный сервис
# -t – использовать TCP сервис
# -u – если хотим обслуживать UDP
# -далее идет ip адрес и порт
# -s – планировщик, т.е. каким способом будет выбираться реальный сервер
# -rr – я выбрал round robin
ipvsadm -A -t 192.200.0.198:80 -s rr
</code>

Этой командой добавляем реальные сервера
<code>
# -a – добавить реальный сервер
# -t – использовать TCP сервис
# -далее идет ip адрес и порт
# -r – ip реального сервера
# -далее собственно и происходит выбор вида роутинга
# -g – gatewaying (direct routing)
# -i – IPIP Tunneling
# -m – masquerading (NAT)
ipvsadm -a -t 192.200.0.198:80 -r 192.200.0.20:80 -g
ipvsadm -a -t 192.200.0.198:80 -r 192.200.0.21:80 –g
</code>

Более подробно читайте # man ipvsadm
